# Scenario Mode (시나리오 모드)

## Overview

시나리오 모드는 **가상의 대중교통 시나리오**를 생성하여 경로탐색 결과를 비교 분석하는 기능입니다.

원본 데이터를 수정하지 않고 임시로 시나리오를 적용하여:
- 배차간격 변경 효과 분석
- 노선 운휴/파업 영향 분석
- 신규 노선(GTX 등) 도입 효과 분석

등의 정책 시뮬레이션이 가능합니다.

## Quick Start

```bash
# 프로그램 실행
search.cmd

# 시나리오 모드 진입
[STD, n=5] > scenario

# 2호선 배차간격 2배로 변경
[SCENARIO:0, 미적용] > headway 2호선 2.0

# 시나리오 적용
[SCENARIO:1, 미적용] > apply

# 원본 vs 시나리오 비교
[SCENARIO:1, 적용됨] > compare 37.5547 126.9707 37.4979 127.0276 09:00

# 시나리오 모드 종료 (원본 상태로 복귀)
[SCENARIO:1, 적용됨] > exit
```

---

## Commands Reference

### 시나리오 관리

| Command | Description | Example |
|---------|-------------|---------|
| `scenario` | 시나리오 모드 진입 | `scenario` |
| `list` | 현재 수정사항 목록 | `list` |
| `clear` | 모든 수정사항 제거 | `clear` |
| `apply` | 시나리오 적용 | `apply` |
| `exit` | 시나리오 모드 종료 (원본 복귀) | `exit` |

### 노선 수정

| Command | Description | Example |
|---------|-------------|---------|
| `headway <노선> <배율>` | 배차간격 조정 | `headway 2호선 2.0` |
| `disable <노선>` | 노선 비활성화 | `disable 9호선` |
| `add-route` | 신규 노선 추가 (대화형) | `add-route` |

### 검색 및 비교

| Command | Description | Example |
|---------|-------------|---------|
| `search <출발lat> <출발lon> <도착lat> <도착lon> <시간>` | 시나리오 상태에서 검색 | `search 37.55 126.97 37.50 127.03 09:00` |
| `compare <출발lat> <출발lon> <도착lat> <도착lon> <시간>` | 원본 vs 시나리오 비교 | `compare 37.55 126.97 37.50 127.03 09:00` |

### 유틸리티

| Command | Description | Example |
|---------|-------------|---------|
| `route <검색어>` | 노선 검색 | `route 2호선` |
| `stop <검색어>` | 정류장 검색 | `stop 강남역` |
| `n=<숫자>` | 결과 수 변경 | `n=10` |
| `help` | 도움말 | `help` |

---

## Feature Details

### 1. 배차간격 조정 (Headway Modification)

노선의 배차간격을 조정하여 운행 빈도 변화 효과를 분석합니다.

**Syntax:**
```
headway <노선명> <배율>
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| 노선명 | String | 노선 검색 패턴 (예: "2호선", "402번", "버스_402") |
| 배율 | Double | 배차간격 배율 (1.0 = 변화없음) |

**배율 의미:**

| 배율 | 배차간격 | 운행수 | 예시 |
|------|----------|--------|------|
| `2.0` | 2배 증가 | 50% 감소 | 5분→10분 |
| `1.5` | 1.5배 증가 | 67% 감소 | 10분→15분 |
| `0.5` | 50% 감소 | 2배 증가 | 10분→5분 |
| `0.8` | 20% 감소 | 25% 증가 | 10분→8분 |

**Example:**
```
[SCENARIO] > headway 2호선 2.0
✓ 2호선: 배차간격 2.0배 (감소, 312→156 트립)

[SCENARIO] > headway 신분당선 0.5
✓ 신분당선: 배차간격 0.5배 (증가, 186→372 트립)
```

**노선명 검색 패턴:**

| 패턴 | 매칭 방식 | 예시 |
|------|----------|------|
| `2호선` | routeShortName 포함 | 2호선 모든 패턴 |
| `402` | routeShortName 포함 | 402번 버스 |
| `버스_402` | 버스 타입 + 402 포함 | 402번 버스만 |
| `지하철_2` | 지하철 타입 + 2 포함 | 2호선만 |
| `ROUTE:12345` | routeId 정확히 일치 | 특정 routeId |

---

### 2. 노선 비활성화 (Disable Route)

특정 노선을 비활성화하여 파업, 사고, 공사 등의 시나리오를 시뮬레이션합니다.

**Syntax:**
```
disable <노선명>
```

**Example:**
```
[SCENARIO] > disable 9호선
✓ 9호선 비활성화 (24개 노선, 1,847개 트립)

[SCENARIO] > disable 버스_402
✓ 버스_402 비활성화 (2개 노선, 89개 트립)
```

**Use Cases:**
- 지하철 파업 시나리오
- 특정 노선 폐선 영향 분석
- 공사로 인한 운휴 영향 분석

---

### 3. 신규 노선 추가 (Add Route)

새로운 노선을 추가하여 신규 노선 도입 효과를 분석합니다.

**Syntax:**
```
add-route
```

대화형으로 다음 정보를 입력합니다:

| 항목 | 설명 | 예시 |
|------|------|------|
| 노선 이름 | 노선 표시명 | `GTX-A` |
| 노선 타입 | GTFS route_type | `1`=지하철, `2`=철도, `3`=버스 |
| 정류장 | 경유 정류장 목록 | 검색으로 선택 |
| 소요시간 | 정류장 간 소요시간 (분) | `8`, `15` |
| 첫차 | 첫차 시간 | `05:30` |
| 막차 | 막차 시간 | `24:00` |
| 배차간격 | 배차간격 (분) | `5` |

**Example: GTX-A 노선 추가**
```
[SCENARIO] > add-route

노선 이름: GTX-A
노선 타입 (1=지하철, 2=철도, 3=버스) [3]: 2

정류장 입력 (이름으로 검색, 'done'으로 완료):
  1번: 운정 → 선택됨
  2번: 킨텍스 → 선택됨
  3번: 대곡 → 선택됨
  4번: 연신내 → 선택됨
  5번: 서울역 → 선택됨
  6번: 삼성 → 선택됨
  7번: 수서 → 선택됨
  8번: 성남 → 선택됨
  9번: 동탄 → 선택됨
  10번: done

소요시간 (분):
  운정 → 킨텍스: 3
  킨텍스 → 대곡: 4
  대곡 → 연신내: 5
  연신내 → 서울역: 7
  서울역 → 삼성: 8
  삼성 → 수서: 5
  수서 → 성남: 10
  성남 → 동탄: 12

첫차 [06:00]: 05:30
막차 [23:00]: 24:00
배차간격 (분) [10]: 5

✓ 신규 노선 'GTX-A' 추가 (9개 정류장, 222개 트립)

[SCENARIO] > apply
✓ 시나리오 적용 완료 (0.05초)

[SCENARIO] > compare 37.7136 126.7680 37.5088 127.0631 08:00
```

**GTX-A 효과 비교 결과:**
```
=== 원본 (GTX-A 없음) ===
[원본] 3개 경로 (0.312초)
  1. 08:05출발 87분, 환승2회: 경의중앙선 → 1호선 → 2호선
  2. 08:12출발 92분, 환승2회: 경의중앙선 → 공항철도 → 9호선

=== 시나리오 (GTX-A 도입) ===
[시나리오] 4개 경로 (0.287초)
  1. 08:10출발 45분, 환승1회: GTX-A → 2호선         ⭐ 42분 단축!
  2. 08:15출발 48분, 환승1회: GTX-A → 분당선

=== 비교 결과 ===
┌─────────┬──────────┬──────────┬─────────┐
│         │ 원본     │ 시나리오 │ 차이    │
├─────────┼──────────┼──────────┼─────────┤
│ 최소시간│ 87분     │ 45분     │ -42분   │
│ 최소환승│ 2회      │ 1회      │ -1회    │
└─────────┴──────────┴──────────┴─────────┘
→ GTX-A 도입으로 운정→삼성 통근시간 48% 단축!
```

**테스트 좌표 (GTX-A 효과 측정용):**

| 구간 | 출발 좌표 | 도착 좌표 | 예상 효과 |
|------|----------|----------|----------|
| 운정→삼성 | 37.7136, 126.7680 | 37.5088, 127.0631 | 87분→45분 |
| 동탄→서울역 | 37.2000, 127.0960 | 37.5547, 126.9707 | 75분→35분 |
| 킨텍스→수서 | 37.6694, 126.7459 | 37.4872, 127.1017 | 95분→50분 |

---

### 4. 원본 vs 시나리오 비교 (Compare)

원본 데이터와 시나리오 적용 데이터의 경로탐색 결과를 비교합니다.

**Syntax:**
```
compare <출발lat> <출발lon> <도착lat> <도착lon> <시간>
```

**Output:**
```
=== 원본 ===
[원본] 3개 경로 (0.245초)
  1. 09:05출발 32분, 환승1회: 2호선 → 9호선

=== 시나리오 ===
[시나리오] 2개 경로 (0.198초)
  1. 09:08출발 45분, 환승2회: 2호선 → 7호선 → 3호선

=== 비교 결과 ===
┌─────────┬──────────┬──────────┬─────────┐
│         │ 원본     │ 시나리오 │ 차이    │
├─────────┼──────────┼──────────┼─────────┤
│ 최단시간│  32분    │  45분    │ +13분   │
│ 환승횟수│   1회    │   2회    │ +1회    │
│ 경로수  │   3개    │   2개    │ -1개    │
└─────────┴──────────┴──────────┴─────────┘
```

---

## Use Case Examples

### Example 1: 지하철 파업 영향 분석

**시나리오:** 9호선 파업으로 인한 통근 영향 분석

```bash
scenario
disable 9호선
apply
compare 37.5216 126.9243 37.5049 127.0049 09:00  # 여의도→고속터미널
```

**예상 결과:**
- 원본: 9호선 직통 15분
- 시나리오: 2호선+7호선 환승 28분 (+13분)

---

### Example 2: GTX-A 도입 효과 분석

**시나리오:** GTX-A 개통 후 동탄→삼성 통근시간 변화

```bash
scenario
add-route
  # GTX-A 노선 추가 (위 예시 참조)
apply
compare 37.2003 127.0960 37.5088 127.0631 08:00  # 동탄→삼성
```

**예상 결과:**
- 원본: 지하철 환승 70분+
- 시나리오: GTX-A 직통 27분 (-43분)

---

### Example 3: 배차 증편 효과 분석

**시나리오:** 출퇴근 시간 2호선 20% 증편

```bash
scenario
headway 2호선 0.8
apply
compare 37.5547 126.9707 37.4979 127.0276 08:30  # 서울역→강남
```

**예상 결과:**
- 대기시간 단축으로 총 소요시간 2-3분 감소

---

### Example 4: 복합 시나리오

**시나리오:** 9호선 파업 + 임시 셔틀버스 투입

```bash
scenario
disable 9호선
add-route
  # 여의도-고속터미널 임시 셔틀 추가
apply
compare 37.5216 126.9243 37.5049 127.0049 09:00
```

---

## Architecture

### Class Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        ScenarioCli                          │
│  - 대화형 CLI 인터페이스                                      │
│  - 명령어 파싱 및 실행                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    ScenarioManager                          │
│  - 수정사항(Modification) 관리                               │
│  - 시나리오 적용 (apply)                                     │
│  - 노선/정류장 검색                                          │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│HeadwayModification│ │DisableRouteModification│ │AddRouteModification│
│ - 배차간격 조정   │ │ - 노선 비활성화  │ │ - 신규 노선 추가 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  ScenarioTransitData                        │
│  - 원본 TransitData 래핑                                     │
│  - 수정된 노선만 오버레이 (메모리 효율)                        │
│  - 비활성화 노선 필터링                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     KoreanRaptor                            │
│  - AccessEgressFinder 재사용 (OSM 매핑 캐시)                 │
│  - 동일한 경로탐색 API                                       │
└─────────────────────────────────────────────────────────────┘
```

### Data Flow

```
원본 TransitData (불변)
       │
       │ 참조
       ▼
ScenarioManager
  └── modifications[]
       ├── HeadwayModification
       ├── DisableRouteModification
       └── AddRouteModification
       │
       │ apply()
       ▼
ScenarioTransitData
  ├── originalData (참조)
  ├── modifiedRoutes (수정된 노선만)
  ├── disabledRoutes (비활성화 인덱스)
  └── addedRoutes (추가된 노선)
       │
       │ 래핑
       ▼
KoreanRaptor (AccessEgressFinder 재사용)
       │
       │ route() / routeMultiCriteria()
       ▼
경로탐색 결과
```

### Memory Efficiency

| 항목 | 크기 | 설명 |
|------|------|------|
| 원본 TransitData | ~2GB | OSM 포함 |
| 시나리오 오버레이 | ~5MB | 수정된 노선만 |
| AccessEgressFinder | 재사용 | OSM 매핑 캐시 |

**장점:**
- 원본 데이터 재로드 불필요
- 시나리오 전환 0.1초 이내
- 다중 시나리오 비교 가능

---

## File Structure

```
korean-otp/src/main/java/kr/otp/scenario/
├── Modification.java              # 수정 인터페이스
├── HeadwayModification.java       # 배차간격 조정
├── DisableRouteModification.java  # 노선 비활성화
├── AddRouteModification.java      # 신규 노선 추가
├── RouteSearcher.java             # 노선 검색 유틸리티
├── StopSearcher.java              # 정류장 검색 유틸리티
├── ScenarioTransitData.java       # 수정 데이터 래퍼
├── ScenarioTransitDataProvider.java  # Raptor SPI 래퍼
├── ScenarioManager.java           # 시나리오 관리자
└── ScenarioCli.java               # CLI 인터페이스
```

---

## Limitations

1. **단방향 노선만 지원**: 양방향 노선 추가 시 각각 별도로 추가 필요
2. **정류장 추가 미지원**: 신규 노선은 기존 정류장만 사용 가능
3. **환승 연계 자동 생성 안됨**: 신규 노선의 환승은 도보 거리 기반
4. **세션 한정**: 시나리오는 프로그램 종료 시 삭제됨

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-01-19 | 초기 릴리즈 - headway, disable, add-route 지원 |

---

*Last Updated: 2025-01-19*
